# Changelog - 14/11/2025

## Correção da Listagem de Vagas

### Problema Identificado
A listagem de vagas não estava exibindo os dados do banco de dados MySQL. O sistema havia sido migrado de CSV para banco de dados, mas os templates e o arquivo `database.py` na raiz do projeto estavam desatualizados.

### Correções Realizadas

#### 1. Atualização dos Templates
**Arquivos modificados:**
- `templates/vagas_public.html`
- `templates/admin_dashboard.html`

**Mudanças:**
- Substituído `v.arquivo` por `v.id` nas URLs
- Atualizado parâmetros das rotas:
  - `url_for('vaga_view', filename=v.arquivo)` → `url_for('vaga_view', servico_id=v.id)`
  - `url_for('download_file', filename=v.arquivo)` → `url_for('download_file', servico_id=v.id)`
  - `url_for('admin_delete', filename=v.arquivo)` → `url_for('admin_delete', servico_id=v.id)`

#### 2. Sincronização do database.py
**Problema:** O arquivo `database.py` na raiz estava incompleto, faltando métodos essenciais.

**Solução:** Copiado o conteúdo completo de `backend/database.py` para a raiz do projeto.

#### 3. Correção de Nomes de Colunas
**Problema:** O código estava usando `data_cadastro`, mas a coluna no banco se chama `data_criacao`.

**Arquivos corrigidos:**
- `database.py`
- `backend/database.py`

**Mudanças:**
- Substituído todas as referências de `data_cadastro` por `data_criacao`
- Adicionado filtro `WHERE ativo = 1` nas consultas para exibir apenas registros ativos

### Estrutura da Tabela servicos_mei
```
- id (int)
- orgao_demandante (varchar)
- titulo_servico (varchar)
- tipo_atividade (varchar)
- especificacao_atividade (varchar)
- descricao_servico (text)
- outras_informacoes (text)
- endereco (varchar)
- numero (varchar)
- bairro (varchar)
- forma_pagamento (enum)
- prazo_pagamento (varchar)
- prazo_expiracao (date)
- data_limite_execucao (date)
- data_criacao (timestamp)
- data_atualizacao (timestamp)
- ativo (tinyint)
```

### Resultado
✅ Listagem de vagas funcionando corretamente
✅ Dados sendo recuperados do banco de dados MySQL
✅ 12 serviços ativos exibidos na listagem
✅ Templates atualizados para usar IDs ao invés de nomes de arquivo

### Testes Realizados
- Consulta direta ao banco: 12 serviços recuperados
- Acesso à rota `/vagas`: Listagem exibida corretamente
- Verificação HTML: Dados renderizados nos templates

#### 4. Correção de Sintaxe SQL
**Problema:** Query SQL com `WHERE` duplicado no método `get_servico_by_id`.

**Erro:**
```sql
FROM servicos_mei WHERE ativo = 1
WHERE id = %s
```

**Correção:**
```sql
FROM servicos_mei
WHERE ativo = 1 AND id = %s
```

### Script de Teste Criado
Criado `scripts/test_listagem_vagas.py` para validar:
- ✅ Conexão com banco de dados
- ✅ Contagem de serviços (12 ativos)
- ✅ Listagem de serviços
- ✅ Busca por ID específico

#### 5. Correção dos Templates de Visualização
**Arquivos modificados:**
- `templates/vaga_view.html`
- `templates/service_success.html`

**Problema:** Templates ainda referenciavam `csv_file` e `filename` ao invés de `servico_id`.

**Correção:**
- `url_for('download_file', filename=csv_file)` → `url_for('download_file', servico_id=servico_id)`
- `url_for('download_file', filename=csv_file)` → `url_for('download_file', servico_id=service_id)`

### Scripts de Teste Criados

#### 1. test_listagem_vagas.py
Valida operações do banco de dados:
- ✅ Conexão com MySQL
- ✅ Contagem de serviços (12 ativos)
- ✅ Listagem de serviços
- ✅ Busca por ID específico

#### 2. test_visualizacao_vagas.py
Valida interface web via HTTP:
- ✅ Página de listagem (/vagas)
- ✅ Visualização individual (/vaga/12)
- ✅ Download de CSV (/download/12)

### Status Final
✅ **Listagem de vagas funcionando**
✅ **Visualização individual funcionando**
✅ **Download de CSV funcionando**
✅ **Todos os campos sendo exibidos corretamente**
✅ **12 serviços ativos no banco de dados**

### Próximos Passos Sugeridos
- Testar exclusão de vagas no painel admin
- Verificar se o frontend React também está funcionando corretamente
- Testar criação de novos serviços via formulário
